<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Leaflet - Prototype</title>
    <meta name="author" content="Sascha Popp, Thomas Maurhart">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link href="manifest.webmanifest" rel="manifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#2b3e51">
    <meta name="msapplication-TileColor" content="#2b3e51">
    <meta name="theme-color" content="#2b3e51">

    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-tilelayer-wmts.js"></script>


</head>
<body onload="getLocation();">
    <div id="mapid"></div>

    <script>
        var mymap = L.map('mapid', {
            minZoom: 18,
            maxZoom: 18,
            zoomControl: false
        }).setView([47.583896, 12.173329], 18);

        mymap.setMaxBounds(mymap.getBounds());

        //mymap.dragging.disable();
            mymap.touchZoom.disable();
            mymap.doubleClickZoom.disable();
            mymap.scrollWheelZoom.disable();

        var ign = new L.tileLayer("https://{s}.wien.gv.at/basemap/bmaporthofoto30cm/normal/google3857/{z}/{y}/{x}.jpeg", {
            subdomains: ['maps', 'maps1', 'maps2', 'maps3', 'maps4'],
            attribution: '&copy; <a href="http://basemap.at">Basemap.at</a>, Sascha & Tom'
        });

        mymap.addLayer(ign);

        var marker = L.marker([47.583896, 12.173329]).addTo(mymap);

        function getLocation() {

            // Check whether browser supports Geolocation API or not
            if (navigator.geolocation) { // Supported
                watchID = navigator.geolocation.watchPosition(function(position) {
                    getPosition(position);
                });

            } else { // Not supported
                alert("Oops! This browser does not support HTML Geolocation.");
            }
        }

        function getPosition(position) {
            var latlng = new L.LatLng(position.coords.latitude, position.coords.longitude);
            mymap.setZoom(11);
            mymap.setView(latlng, 18);
            marker.setLatLng(latlng);
            console.log(latlng);
        }

        function catchError(positionError) {
            switch (positionError.code) {
                case positionError.TIMEOUT:
                    alert("The request to get user location has aborted as it has taken too long.");
                    break;
                case positionError.POSITION_UNAVAILABLE:
                    alert("Location information is not available.");
                    break;
                case positionError.PERMISSION_DENIED:
                    alert("Permission to share location information has been denied!");
                    break;
                default:
                    alert("An unknown error occurred.");
            }
        }

        var icon = L.Icon.Default.imagePath = 'images/';
        var customIcon = L.icon({
            iconUrl: L.Icon.Default.imagePath + 'marker-point-red-icon.png',
            shadowUrl: L.Icon.Default.imagePath + 'marker-point-shadow.png',
            iconSize: [24, 32],
            shadowSize: [41, 41],
            iconAnchor: [12, 32],
            shadowAnchor: [14, 41],
            popupAnchor: [0, -32]
        });

        var locations = [
            ["LOCATION_1", 47.58415734, 12.17140172],
            ["LOCATION_2", 47.58354222, 12.1716553],
            ["LOCATION_3", 47.58342643, 12.17369378]
        ];

        for (var i = 0; i < locations.length; i++) {
            markerTarget = new L.marker([locations[i][1], locations[i][2]], {
                icon: customIcon
            }).addTo(mymap);
        }

        var allPoints = [
                [47.58395109, 12.17326462],
                [47.58354222, 12.1716553],
                [47.58342643, 12.17369378]
            ];

        var walkDistancePoints = [];
            var nearDistancePoints = [];
            var nearDistanceMarkers = [];
            var walkingDistance = 5000;
            var nearDistance = 20;
            var startWalkDistance;
            var firstTime = true;

            function getWalkDistancePoints(latlng) {
                walkDistancePoints = [];
                var j = 0;
                for (var i = 0; i < allPoints.length; i++) {
                    if (mymap.distance(latlng, allPoints[i]) <= walkingDistance) {
                        walkDistancePoints[j] = allPoints[i];
                        j++;
                    }

      
                }
                if (walkDistancePoints.length > 0) {
                    startWalkDistance = latlng;
                }
            }

            function checkForNearPoints(latlng) {
                for (var i = 0; i < nearDistancePoints.length; i++) {
                    if (mymap.distance(latlng, nearDistancePoints[i]) > nearDistance) {
                        nearDistanceMarkers.splice(i, 1);
                        nearDistancePoints.splice(i, 1);
                    }
                }
                for (var i = 0; i < walkDistancePoints.length; i++) {
                    if (mymap.distance(latlng, walkDistancePoints[i]) <= nearDistance) {
                        if ((nearDistancePoints.length == 0) || (nearDistancePoints.indexOf(walkDistancePoints[i]) < 0)) {
                            nearDistanceMarkers.push(L.marker(walkDistancePoints[i]).addTo(mymap));
                            nearDistancePoints.push(walkDistancePoints[i]);
                        }
                    }
                }
            }

            function onLocationFound(e) {
                walkDistancePoints = [];
                if ((walkDistancePoints.length == 0) || (mymap.distance(e.latlng, startWalkDistance) < (walkingDistance / 2))) {
                    getWalkDistancePoints(e.latlng);
                }
                checkForNearPoints(e.latlng);
            }
            mymap.on('locationfound', onLocationFound);

            mymap.locate({ setView: true, watch: true, maxZoom: 8 }); 

        if ('serviceWorker' in navigator) {
                navigator.serviceWorker
                    .register('sw.js')
                    .then(function () { console.log("Service Worker Registered"); });
            }

    </script>

</body>

</html>
