<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Leaflet - Prototype</title>
    <meta name="author" content="Sascha Popp, Thomas Maurhart">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link href="manifest.webmanifest" rel="manifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#2b3e51">
    <meta name="msapplication-TileColor" content="#2b3e51">
    <meta name="theme-color" content="#2b3e51">

    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-tilelayer-wmts.js"></script>


</head>

<body>
    <div id="mapid"></div>

    <script>
        // settings
        let currentPositionMarker;
        let currentPostion;
        let targets = [];
        let minDistanceToMarker = 50; // in metres - change to 10 or so for live

        // icons for random locations
        let icon = L.Icon.Default.imagePath = 'images/';
        let customIcon = L.icon({
            iconUrl: L.Icon.Default.imagePath + 'marker-point-red-icon.png',
            shadowUrl: L.Icon.Default.imagePath + 'marker-point-shadow.png',
            iconSize: [24, 32],
            shadowSize: [41, 41],
            iconAnchor: [12, 32],
            shadowAnchor: [14, 41],
            popupAnchor: [0, -32]
        });

        // init the map
        let map = L.map('mapid').fitWorld();
        map.zoomControl.remove();

        // add the layer
        // Austrian basemap but used mapbox below for now for worldview
        // L.tileLayer("https://{s}.wien.gv.at/basemap/bmaporthofoto30cm/normal/google3857/{z}/{y}/{x}.jpeg", {
        //     subdomains: ['maps', 'maps1', 'maps2', 'maps3', 'maps4'],
        //     attribution: '&copy; <a href="http://basemap.at">Basemap.at</a>, Paula, Emanuel, Guni, Tom',
        //     minZoom: 18,
        //     maxZoom: 18,
        //     zoomControl: false
        // }).addTo(map);

        // Mapbox Street Map
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZ3VuaGFydGgiLCJhIjoiY2p3dG5pdDI5MDFmMDQzbzRlZ2RkMXN0diJ9.cu5CtQ7YyINFsEOya5c8Bg', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            maxZoom: 18,
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoiZ3VuaGFydGgiLCJhIjoiY2p3dG5pdDI5MDFmMDQzbzRlZ2RkMXN0diJ9.cu5CtQ7YyINFsEOya5c8Bg'
        }).addTo(map);

        // geolocation
        map.locate({ setView: true });
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // geolocation success
        function onLocationFound(e) {
            let radius = e.accuracy;
            currentPositionMarker = L.marker(e.latlng).addTo(map);
            currentPostion = e.latlng;
            map.setMaxBounds(map.getBounds());

            // put 5 random positions within the map bound and add to targets array
            for (let i = 0; i < 5; i++) {
                targets[i] = new L.marker(getRandomLatLng(map), {
                    icon: customIcon
                }).on('click', targetOnClick).addTo(map);
                targets[i].bindPopup('', { autoPan: false, keepInView: true });
            }

            // geolocation watcher
            if (navigator.geolocation) {
                watchID = navigator.geolocation.watchPosition(function (position) {
                    updateCurrentMarkerPosition(position);
                });
            } else { // Not supported
                alert("Oops! This browser does not support HTML Geolocation.");
            }
        }

        // geolocation error
        function onLocationError(e) {
            alert(e.message);
        }

        // generate a random location within the map bounds
        function getRandomLatLng(map) {
            let bounds = map.getBounds().pad(-0.15),
                southWest = bounds.getSouthWest(),
                northEast = bounds.getNorthEast(),
                lngSpan = northEast.lng - southWest.lng,
                latSpan = northEast.lat - southWest.lat;
            return new L.LatLng(
                southWest.lat + latSpan * Math.random(),
                southWest.lng + lngSpan * Math.random());
        }

        // Click on target
        function targetOnClick(e) {
            let distance = Math.floor(map.distance(currentPostion, e.latlng));
            let pop = e.target.getPopup();
            pop.setContent(`Distance: ${distance} meters`).openPopup();
        }

        // update the current position marker on the map
        function updateCurrentMarkerPosition(currentPostion) {
            let latlng = new L.LatLng(currentPostion.coords.latitude, currentPostion.coords.longitude);
            map.setView(latlng, 18);
            currentPositionMarker.setLatLng(latlng);
            checkOnTargets(latlng);
        }

        // check if we are close to a target
        // if yes, let's just remove it for now
        function checkOnTargets(latlng) {
            for(let i = 0; i < targets.length; i++) {
                let distance = Math.floor(map.distance(latlng, targets[i].getLatLng()));
                if (distance <= minDistanceToMarker) {
                    map.removeLayer(targets[i]);
                }
            }

        }

    </script>

</body>

</html>
