<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Leaflet - Prototype</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link href="manifest.webmanifest" rel="manifest">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#2b3e51">
    <meta name="msapplication-TileColor" content="#2b3e51">
    <meta name="theme-color" content="#2b3e51">

    <link href="css/leaflet.css" rel="stylesheet">
    <link href="css/style.css" rel="stylesheet">

    <script src="js/leaflet.js"></script>
    <script src="js/leaflet-tilelayer-wmts.js"></script>

</head>

<body>
    <header>
        <div id="gamestate"></div>
        <a href="#" id="restart">
            <!-- Generated by IcoMoon.io -->
            <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
                <title></title>
                <g id="icomoon-ignore">
                </g>
                <path
                    d="M444.84 83.16c-46.804-51.108-114.077-83.16-188.84-83.16-141.385 0-256 114.615-256 256h48c0-114.875 93.125-208 208-208 61.51 0 116.771 26.709 154.848 69.153l-74.848 74.847h176v-176l-67.16 67.16z">
                </path>
                <path
                    d="M464 256c0 114.875-93.125 208-208 208-61.51 0-116.771-26.709-154.847-69.153l74.847-74.847h-176v176l67.16-67.16c46.804 51.108 114.077 83.16 188.84 83.16 141.385 0 256-114.615 256-256h-48z">
                </path>
            </svg>

        </a>
    </header>
    <div id="mapid"></div>

    <script>
        // settings
        let currentPositionMarker;
        let currentPosition;
        let targets = [];
        let numberOfTargets = 5; // Number of targets to find
        let minDistanceToMarker = 20; // in metres - change to 10 or so for live
        let cssIcon = L.divIcon({ className: 'redMarker', iconSize: [20, 20] });

        // restart
        let restart = document.querySelector('#restart');
        restart.addEventListener('click', (e) => {
            e.preventDefault();
            resetMap();
        });
        // game state field
        let gamestate = document.querySelector('#gamestate');
        gamestate.innerHTML = `${numberOfTargets} to go`;

        // init the map
        let map = L.map('mapid', {
            minZoom: 18,
            maxZoom: 18,
            zoomControl: false
        })
        //.setView([52.520007, 13.404954], 18);

        //map.zoomControl.remove();
        map.touchZoom.disable();
        map.doubleClickZoom.disable();
        map.scrollWheelZoom.disable();

        // add the layer
        // Austrian basemap but used mapbox below for now for worldview
        // L.tileLayer("https://{s}.wien.gv.at/basemap/bmaporthofoto30cm/normal/google3857/{z}/{y}/{x}.jpeg", {
        //     subdomains: ['maps', 'maps1', 'maps2', 'maps3', 'maps4'],
        //     attribution: '&copy; <a href="http://basemap.at">Basemap.at</a>, Paula, Emanuel, Guni, Tom',
        // }).addTo(map);

        // Mapbox Street Map
        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZ3VuaGFydGgiLCJhIjoiY2p3dG5pdDI5MDFmMDQzbzRlZ2RkMXN0diJ9.cu5CtQ7YyINFsEOya5c8Bg', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets',
            accessToken: 'pk.eyJ1IjoiZ3VuaGFydGgiLCJhIjoiY2p3dG5pdDI5MDFmMDQzbzRlZ2RkMXN0diJ9.cu5CtQ7YyINFsEOya5c8Bg'
        }).addTo(map);

        let targetsGroup = L.layerGroup().addTo(map);

        // geolocation
        map.locate({ 'setView': true });
        map.on('locationfound', onLocationFound);
        map.on('locationerror', onLocationError);

        // geolocation success
        function onLocationFound(e) {

            currentPosition = e.latlng;
            map.setMaxBounds(map.getBounds());
            addTargets();
            //let radius = e.accuracy;
           // map.panTo(e.latlng, 18);

            //if (typeof (currentPositionMarker) === 'undefined') {
                currentPositionMarker = L.marker(e.latlng).addTo(map);
                // geolocation watcher
                if (navigator.geolocation) {
                    navigator.geolocation.watchPosition(function (position) {
                        updateCurrentMarkerPosition(position);
                    });
                }
            // } else {
            //     currentPositionMarker.setLatLng(e.latlng);
            // }


            // put N random positions / targets within the map bound and add to targets array

        }

        // geolocation error
        function onLocationError(e) {
            alert(e.message);
        }

        // reset map targets
        function resetMap() {
            location.reload();
            // targets = [];
            // targetsGroup.clearLayers();
            // gamestate.innerHTML = `${numberOfTargets} to go`;
            // map.locate();
            //map.setView([currentPosition.lat, currentPosition.lng], 18);
        }

        // add random Targets
        function addTargets() {
            for (let i = 0; i < numberOfTargets; i++) {
                targets[i] = new L.marker(getRandomLatLng(map), {
                    icon: cssIcon
                }).on('click', targetOnClick).addTo(targetsGroup);
                targets[i].bindPopup('', { autoPan: false, keepInView: true });
            }
        }

        // generate a random location within the map bounds
        function getRandomLatLng(map) {
            let bounds = map.getBounds().pad(-0.15),
                southWest = bounds.getSouthWest(),
                northEast = bounds.getNorthEast(),
                lngSpan = northEast.lng - southWest.lng,
                latSpan = northEast.lat - southWest.lat;
            return new L.LatLng(
                southWest.lat + latSpan * Math.random(),
                southWest.lng + lngSpan * Math.random());
        }

        // Click on target
        function targetOnClick(e) {
            let distance = Math.floor(map.distance(currentPosition, e.latlng));
            let pop = e.target.getPopup();
            pop.setContent(`Distance: ${distance} meters`).openPopup();
        }

        // update the current position marker on the map
        function updateCurrentMarkerPosition(currentPosition) {
            currentPosition = new L.LatLng(currentPosition.coords.latitude, currentPosition.coords.longitude);
            map.setView(currentPosition, 18);
            currentPositionMarker.setLatLng(currentPosition);
            checkOnTargets(currentPosition);
        }

        // check if we are close to a target
        // if yes, let's just remove it for now
        function checkOnTargets(latlng) {
            let targetsToRemove = '';
            for (let i = 0; i < targets.length; i++) {
                let distance = Math.floor(map.distance(latlng, targets[i].getLatLng()));
                if (distance <= minDistanceToMarker) {
                    targets[i].getElement().style.background = 'green';
                    targetsToRemove += i + ',';
                }
            }
            if (targetsToRemove != '') {
                updateTargets(targetsToRemove);
            }
        }

        // Remove reached targets from the targets array
        function updateTargets(targetsToRemove) {
            let removeTargets = targetsToRemove.substring(0, targetsToRemove.length - 1);
            removeTargets = removeTargets.split(',');
            for (let i = removeTargets.length - 1; i >= 0; i--) {
                targets.splice(removeTargets[i], 1);
            }
            gameState();
        }

        function gameState() {
            if (targets.length == 0) {
                gamestate.innerHTML = 'You found all places';
            } else {
                gamestate.innerHTML = `${targets.length} place to go`;
            }
        }

        // if ('serviceWorker' in navigator) {
        //     navigator.serviceWorker
        //         .register('sw.js')
        //         .then(function () { console.log("Service Worker Registered"); });
        // }

    </script>

</body>

</html>
